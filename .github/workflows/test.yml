# .github/workflows/build-and-publish.yml
name: Build and Publish GCC release
on:
  push:
    tags:
      - 'v*'   # publish when you push a tag like "v1.0.0"

permissions:
  contents: write   # needed to create releases / upload assets

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y build-essential git make gawk flex bison \
            libgmp-dev libmpfr-dev libmpc-dev python3 binutils perl libisl-dev libzstd-dev tar gzip bzip2

      - name: Build GCC 15 (install to staging dir)
        env:
          STAGE_DIR: ${{ runner.temp }}/gcc-15-install
        run: |
          set -euo pipefail
          mkdir -p "$STAGE_DIR"
          mkdir -p ~/gcc-15
          cd ~/gcc-15
          git clone https://gcc.gnu.org/git/gcc.git gcc-15-source
          cd gcc-15-source
          git checkout releases/gcc-15.1.0
          ./contrib/download_prerequisites

          mkdir -p ../gcc-15-build
          cd ../gcc-15-build
          ../gcc-15-source/configure --prefix="$STAGE_DIR" --disable-multilib --enable-languages=c,c++
          make -j$(nproc)
          make install   # installs into $STAGE_DIR

      - name: Pack staging dir
        env:
          STAGE_DIR: ${{ runner.temp }}/gcc-15-install
        run: |
          cd ${{ runner.temp }}
          # Create tarball that contains a top-level folder GCC-15 (so extract location is clean)
          tar -czf gcc-15-${{ github.ref_name }}.tar.gz -C "$(dirname "$STAGE_DIR")" "$(basename "$STAGE_DIR")"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: GCC 15 - ${{ github.ref_name }}
          body: "Built GCC 15 binaries"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload tarball to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ runner.temp }}/gcc-15-${{ github.ref_name }}.tar.gz
          asset_name: gcc-15-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
