# .github/workflows/build-and-publish.yml
name: Build and Publish GCC release
on:
  workflow_dispatch:
    inputs:
      pragma_branch:
        description: 'Which branch of Pragma to use'
        required: true
        default: 'develop'
        type: string

permissions:
  contents: write   # needed to create releases / upload assets

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y build-essential git make gawk flex bison \
            libgmp-dev libmpfr-dev libmpc-dev python3 binutils perl libisl-dev libzstd-dev tar gzip bzip2

      - name: Build GCC 15 (install to staging dir)
        env:
          STAGE_DIR: ${{ runner.temp }}/gcc-15-install
        run: |
          set -euo pipefail
          mkdir -p "$STAGE_DIR"
          mkdir -p ~/gcc-15
          cd ~/gcc-15
          git clone https://gcc.gnu.org/git/gcc.git gcc-15-source
          cd gcc-15-source
          git checkout releases/gcc-15.1.0
          ./contrib/download_prerequisites

          mkdir -p ../gcc-15-build
          cd ../gcc-15-build
          ../gcc-15-source/configure --prefix="$STAGE_DIR" --disable-multilib --enable-languages=c,c++
          #make -j$(nproc)
          #make install   # installs into $STAGE_DIR

      - name: Pack staging dir
        env:
          STAGE_DIR: ${{ runner.temp }}/gcc-15-install
        run: |
          cd ${{ runner.temp }}
          # Create tarball that contains a top-level folder GCC-15 (so extract location is clean)
          tar -czf gcc-15-${{ github.ref_name }}.tar.gz -C "$(dirname "$STAGE_DIR")" "$(basename "$STAGE_DIR")"

      - name: Create Release Archive
        shell: bash
        run: |
          curDir="$PWD"
          mv "/" "$curDir/gcc-15-${{ github.ref_name }}.tar.gz"

      - name: Generate nightly tag description
        shell: bash
        run:   |
          printf "Pre-built third-party libraries for Pragma." > tag_text.txt

      - name: Compute build‐tag as today’s date
        id: get_date
        shell: bash
        run: |
          echo "date=$(TZ='Europe/Berlin' date +%F)" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: "pragma-deps-lib"
          
      - name: Create Tag
        uses: Silverlan/common_actions/create_tag@main
        with:
          tag_name: "${{ steps.get_date.outputs.date }}"
          path: "pragma-deps-lib"

      - name: Update nightly tag description
        uses: softprops/action-gh-release@v0.1.15
        with:
          body_path: tag_text.txt
          tag_name: "${{ steps.get_date.outputs.date }}"
          target_commitish: ${{ github.sha }}
          prerelease: true

      - name: Update nightly release
        uses: pyTooling/Actions/releaser/composite@v4.2.2
        with:
          tag: "${{ steps.get_date.outputs.date }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          files: "gcc-15-${{ github.ref_name }}.tar.gz"
